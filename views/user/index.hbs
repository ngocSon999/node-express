<div class="d-flex justify-content-between align-items-center mb-4">
  <h3 class="m-0">{{t 'user.management'}}</h3>
  {{#if (hasPermission user 'create user')}}
  <a class="btn btn-primary btn-sm" href="{{ routes 'usercreate' }}">{{t 'user.createNew'}}</a>
  {{/if}}
</div>

<table class="table table-bordered table-hover align-middle">
  <thead class="table-light">
    <tr>
      <th>#</th>
      <th>{{t 'user.avatar'}}</th>
      <th>{{t 'user.name'}}</th>
      <th>{{t 'user.email'}}</th>
      <th>{{t 'user.phone'}}</th>
      <th>{{t 'user.createdAt'}}</th>
      <th>{{t 'user.roles'}}</th>
      <th>{{t 'common.actions'}}</th>
    </tr>
  </thead>
  <tbody>
    {{#each users}}
      <tr>
        <td>{{@index}}</td>
        <td>
          <img src="{{this.avatar}}" alt="{{t 'user.avatar'}}" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
        </td>
        <td>{{this.name}}</td>
        <td>{{this.email}}</td>
        <td>{{this.phone}}</td>
        <td>{{moment this.createdAt "DD/MM/YYYY hh:mm A" }}</td>
        <td>
          {{#each this.roles}}
            <span class="badge bg-info me-1">{{this.name}}</span>
          {{/each}}
        </td>
        <td>
            {{#if (hasPermission ../user 'read user')}}
            <a href="{{routes 'userDetail' this.id}}" class="btn btn-info btn-sm">{{t 'common.detail'}}</a>
            {{/if}}
            {{#if (hasPermission ../user 'update user')}}
            <a href="{{routes 'userEdit' this.id}}" class="btn btn-sm btn-warning">{{t 'common.edit'}}</a>
            {{/if}}
            {{#if (hasPermission ../user 'delete user')}}
            <button class="btn btn-sm btn-danger" onclick="deleteUser({{this.id}})">{{t 'common.delete'}}</button>
            {{/if}}
        </td>
      </tr>
    {{else}}
      <tr>
        <td colspan="7" class="text-center">{{t 'user.noUsersFound'}}</td>
      </tr>
    {{/each}}
  </tbody>
</table>

<script>
async function deleteUser(id) {
    if (confirm('{{t "user.deleteConfirm"}}')) {
        try {
            const response = await fetch(`/api/v1/user/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                showAlert('{{t "user.deleteSuccess"}}', 'success');
                // Reload the page after a short delay to show the alert
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert(data.message || '{{t "user.deleteError"}}', 'error');
            }
        } catch (error) {
            console.error('Error deleting user:', error);
            showAlert('{{t "error.500"}}', 'error');
        }
    }
}
</script>
