<div class="d-flex justify-content-between align-items-center mb-4">
  <h3 class="m-0">User Management</h3>
  {{#if (hasPermission user 'create user')}}
  <a class="btn btn-primary btn-sm" href="{{ routes 'usercreate' }}">Create new user</a>
  {{/if}}
</div>

<table class="table table-bordered table-hover align-middle">
  <thead class="table-light">
    <tr>
      <th>#</th>
      <th>Avatar</th>
      <th>Name</th>
      <th>Email</th>
      <th>Phone</th>
      <th>Created At</th>
      <th>Roles</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {{#each users}}
      <tr>
        <td>{{@index}}</td>
        <td>
          <img src="{{this.avatar}}" alt="Avatar" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
        </td>
        <td>{{this.name}}</td>
        <td>{{this.email}}</td>
        <td>{{this.phone}}</td>
        <td>{{moment this.createdAt "DD/MM/YYYY hh:mm A" }}</td>
        <td>
          {{#each this.roles}}
            <span class="badge bg-info me-1">{{this.name}}</span>
          {{/each}}
        </td>
        <td>
            {{#if (hasPermission ../user 'read user')}}
            <a href="{{routes 'userDetail' this.id}}" class="btn btn-info btn-sm">Detail</a>
            {{/if}}
            {{#if (hasPermission ../user 'update user')}}
            <a href="{{routes 'userEdit' this.id}}" class="btn btn-sm btn-warning">Edit</a>
            {{/if}}
            {{#if (hasPermission ../user 'delete user')}}
            <button class="btn btn-sm btn-danger" onclick="deleteUser({{this.id}})">Delete</button>
            {{/if}}
        </td>
      </tr>
    {{else}}
      <tr>
        <td colspan="7" class="text-center">No users found.</td>
      </tr>
    {{/each}}
  </tbody>
</table>

<script>
async function deleteUser(id) {
    if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        try {
            const response = await fetch(`/api/v1/user/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                showAlert('User deleted successfully', 'success');
                // Reload the page after a short delay to show the alert
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert(data.message || 'Error deleting user', 'error');
            }
        } catch (error) {
            console.error('Error deleting user:', error);
            showAlert('Error deleting user', 'error');
        }
    }
}
</script>
